# A web-based tool for the interactive exploration of the links between taxonomy and function in metagenomic data

  Human-associated microbial communities, known as the human microbiome, have been associated with a range of diseases including obesity and inflammatory bowel disease. Analyses of these communities through metagenomic sequencing have focused on two related but separate questions: 1) which microbial species are present, and 2) what genetic functions are present?  These functions can be present in all species, some subset of species, or only a single species. The high dimensional nature of these data presents challenges for visualization. A sample may have 500-1,000 different species, each with 1,000-5,000 genes (which can be grouped into a smaller set of functional categories), and a typical study consists of 10-100 samples across different environments, disease states, or time points. 

  Here we have developed a visualization tool to facilitate exploration of this type of dataset. Our tool can display the distributions of species abundances, the distributions of function abundances, and the contributions of each species to each function, and furthermore allows interactive comparisons between different samples. 

### Burrito web address
The homepage for our tool is located [HERE](https://elbo-spice.gs.washington.edu/shiny/burrito/)

## Interacting with burrito
### The homepage
The burrito homepage is a web form that allows the user to select their desired settings for the interactive visualization.

TODO: ADD SCREENSHOT OF TWO OPTIONS WITH CIRCLED & NUMBERED COMMPONENTS 

First, the user chooses whether they want to view the burrito visualziation for an example dataset (1) or upload their own data (2). When viewing an example dataset, the user chooses from various pre-loaded studies (3). 

If the user decides to upload their own data, they have three options for how to provide their data files (all input table files should be tab-delimited with a column header for each column including the first column). 

#### Run PICRUSt option
The first upload option (4) only requires a table of 16S rRNA reads from their own sequencing study, which is then used to generate taxonomy-function links using PICRUSt (TODO: cite PICRUSt). The file format for this option is:

|OTU    |Sample1_Name|Sample2_Name|etc.|
|------:|-----------:|-----------:|---:|
|OTU1_ID|10          |5           |etc.|
|OTU2_ID|0           |5           |etc.|
|etc.   |etc.        |etc.        |etc.|

The `OTU_ID` column must come as the first column in the table.

#### Use PICRUSt output option
The second upload option (5) requires a table of 16S rRNA reads, as in the first option, but to save time the user also supplies the contribution table generated by running PICRUSt themselves. The format for this PICRUSt contribution table should be:

|Gene      |Sample      |OTU    |GeneCountPerGenome|OTUAbundanceInSample|CountContributedByOTU|ContributionPercentOfSample|ContributionPercentOfAllSamples|
|---------:|-----------:|------:|-----------------:|-------------------:|--------------------:|--------------------------:|------------------------------:|
|Gene1_Name|Sample1_Name|OTU1_ID|1.0               |10.0                |10.0                 |0.5                        |0.0002                         |
|Gene1_Name|Sample1_Name|OTU2_ID|2.0               |5.0                 |10.0                 |0.5                        |0.0002                         |
|etc.      |etc.        |etc.   |etc.              |etc.                |etc.                 |etc.                       |etc.                           |

The columns must appear in this order. The OTU IDs and sample names must appropriately match those found in the 16S rRNA read table.

#### Use custom gene annotations
The third upload option (6) allows the user to provide their own genome annotation table for the taxa in their OTU table. The first file is again an OTU talbe of the same format as the first two upload options. The genome annotation file is a table of the format:

|OTU    |Gene      |CopyNumber|
|------:|---------:|---------:|
|OTU1_ID|Gene1_Name|1         |
|OTU2_ID|Gene1_Name|2         |
|etc.   |etc.      |etc.      |

The columns must appear in this order. The OTU IDs must appropriately match those found in the associated OTU table.

#### Optional files
There are four optional files a user can provide when uploading their own data. These files provide additional data that goes beyond the linkage between OTUs and function present in the given samples.

##### Taxonomic hierarchy
The user can provide a custom tree describing the taxonomic relationships between OTUs (7) (by default the visualization uses the Greengenes (TODO: cite Greengenes) taxonomy) in the following format:

|OTU    |Kingdom    |Phylum          |etc.|
|------:|----------:|---------------:|---:|
|OTU1_ID|k__Bacteria|p__Bacteroidetes|etc.|
|OTU2_ID|k__Bacteria|p__Firmicutes   |etc.|
|etc.   |etc.       |etc.            |etc.|

This custom tree must have the OTU ID column first followed by a column for each taxonomic rank from lowest resolution (e.g. Kingdom) to highest resolution (e.g. Species). The user can specify their own taxonomic rank names.

##### Function hierarchy
The user can provide a custom tree describing the hierarchical relationships between functions (8) (by default the visualization uses the BRITE hierarchy (TODO: cite BRITE hierarchy)) in the following format:

|Gene  |Category  |SuperPathway           |etc.|
|-----:|---------:|----------------------:|---:|
|K00001|Metabolism|Carbohydrate Metabolism|etc.|
|K00002|Metabolism|Lipid Metabolism       |etc.|
|etc.  |etc.      |etc.                   |etc.|

This custom hierarchy must have the lowest level ID column first (e.g. KO or gene) followed by a column for each function hierarchy from lowest resolution (e.g. Metabolism) to highest resolution (e.g. SubPathway). The user can specify their own taxonomic rank names.

##### Sample metadata
The user can provide a metadata table (9) linking samples to different groupings or factors (e.g. cases vs. controls) in the following format:

|Sample      |Grouping_1|Grouping_2|etc.|
|-----------:|---------:|---------:|---:|
|Sample1_Name|Case      |Human     |etc.|
|Sample2_Name|Control   |Mouse     |etc.|
|etc.        |etc.      |etc.      |etc.|

##### Function profile for comparison
The user can also provide their own function profile for each sample (10) to compare to the taxonomy-linked function profiles shown in the visualization in the following format:

|Gene  |Sample1_Name|Sample2_Name|etc.|
|-----:|-----------:|-----------:|---:|
|K00001|0.4         |0.2         |etc.|
|K00002|0.3         |0.5         |etc.|
|etc.  |etc.        |etc.        |etc.|

The function profile table must have sample names matching those used in the normal 16S rRNA read count table so that side-by-side comparisons between predicted and measured function profiles  can be made.

#### Final selections

##### Choosing a summary taxonomic level
Once all data upload options are complete, the user selects a taxonomic hierarchy level to summarize the data to (11). The highest-resolution level can be chosen (e.g. OTU) and the user will be able to visualize function contributions down to the OTU level. However, by choosing a lower-resolution level the visualization generation will be faster and the visualization in-browser will require less memory.

##### Choosing a summary function level
The user also must select a function hierarchy level to summarize the data to (12). As with the OTU summary, the highest-resolution level can be chosen, but choosing a lower-resolution level may increase performance.

**WARNING** The BRITE hierarhcy (used by default) maps single KOs to multiple subpathways. If using the default function hierarchy or a custom hierarchy that maps a higher-resolution function level to multiple lower-resolution function levels, the user should summarize to at least the highest-resolution level without such one-to-many mappings (e.g. for the default function hierarchy, summarize to SubPathway or a lower-resolution level). 

##### Choosing a color scheme
The user can select a color scheme (13), which currently has two options. First, the hierarchical color scale attempts to color the nodes of a subtree in the taxonomic or function hierarchy a shade of the parent node's color. Second the random color scale instead assigns random colors to the nodes of the taxonomic and function hierarchies.

##### Choosing a sample grouping
If the user has uploaded a sample metadata file, they can select a column from the metadata to group samples by. This will order the visualization barplot bars to keep samples of the same group together and color the sample names similarly.

##### Generating the visualization
Finally, once all selections have been made, the user can then generate the visualization (15)!

### The visualization

TODO: ADD SCREENSHOT OF FULL VISUALIZATION

#### The function abundance barplot
The function abundance barplot shows the relative abundances of functions in each sample. By hovering over a bar segment, all segments in the function abundance barplot corresponding to the same function will be highlighted.

TODO: ADD SCREENSHOT OF FUNCTION BARPLOT MOUSING OVER SEGMENT

Additionally, when mousing over a bar segment, the corresponding function will be selected in the taxonomy-function connection visualization (connectogram?) as described later.

#### The taxonomic abundance barplot
The taxonomic abundance barplot shows the relative abundances of taxa in each sample. By hovering over a bar segment, all segments in the taxonomic abundance barplots corresponding to the same taxon will be highlighted. At the same time, sub-segments of the function barplot will be highlighted corresponding to the abundance of each function contributed by the hovered taxon in each sample.

TODO: ADD SCREENSHOT OF THE OTU AND FUNCTION BARPLOTS MOUSING OVER AN OTU SEGMENT

Additionally, when mousing over a bar segment, the corresponding taxon will be selected in the taxonomy-function connection visualization (connectogram?) as described later.

#### The taxonomic and function hierarchies
The taxonomic/function hierarchy shows the hierarchical structure of the taxonomic/function relations of the displayed taxa/functions. By clicking on a leaf taxon/function node (node at the rightmost/leftmost part of the hierarchy), the tree will expand that node to show the sub-taxa/-functions of the corresponding taxon/function (if there are any sub-taxa/-functions) in the taxonomic/function hierarchy as well as the taxonomic/function abundance barplot.

TODO: ADD SCREENSHOT OF BEFORE AND AFTER EXPANDING A NODE

Alternatively, by clicking on an interior taxon/function node (any node other than a leaf taxon/function node), the tree will remove all sub-taxa/-functions of that taxon/function, instead just displaying the clicked taxon/function node as a leaf taxon/function node and collapsing the bars corresponding to those sub-taxa/-functions to a single bar for the clicked taxon/function in the taxonomic/function abundance barplot.

TODO: ADD SCREENSHOT OF BEFORE AND AFTER COLLAPSING A NODE

#### The taxonomy-function connection visualization (connectogram?)
TBD

#### Saving the visualization (or visualization components)
Once the user has adjusted the displayed visualization to suit their needs, they can save the entire visualization, or individual components, using the menu...TODO

TODO: ADD SCREENSHOT OF SAVE MENU
